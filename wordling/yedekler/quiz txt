import 'dart:async';
import 'dart:math';
import 'package:flutter/material.dart';
import 'package:wordling/widgets.dart';
import 'data_provider.dart'; // DataProvider sınıfını içe aktarın

class QuizPage extends StatefulWidget {
  const QuizPage({Key? key}) : super(key: key);

  @override
  State<QuizPage> createState() => _QuizPageState();
}

class _QuizPageState extends State<QuizPage> {
  Widgets widgets = Widgets();
  final DataProvider dataProvider = DataProvider(); // DataProvider örneği oluşturun
  String question = ''; // Soru metni
  String correctAnswer = ''; // Doğru cevap
  List<String> choices = []; // Seçeneklerin listesi
  Color boxColor = Color(0xFFBCEFD0);
  Random random = Random();
  bool containsForbiddenLetters = false;

  @override
  void initState() {
    super.initState();
    _initializeQuiz();
  }

  void _initializeQuiz() async {
    // DataProvider ile rastgele 3 kelime çekme işlemi
    final List<Map<String, dynamic>?> randomWordsData = [];

    for (int i = 0; i < 3; i++) {
      final randomWordData = await dataProvider.getRandomWord();
      if (randomWordData != null) {

        randomWordsData.add(randomWordData);
      }
    }
    int randomNumber = random.nextInt(2) + 1;
    // Soru ve seçenekleri ayarla
    final randomIndex = Random().nextInt(3);
    final randomWordData = randomWordsData[randomIndex];

    if (randomWordData != null) {
      setState(() {
        if(randomNumber==2){
          question = '${randomWordData['word']}';
          correctAnswer = randomWordData['meaning'];

          // Şıkları karıştırın ve sırayla A, B, C olarak atayın
          choices = [
            randomWordsData[0]!['meaning'] as String,
            randomWordsData[1]!['meaning'] as String,
            randomWordsData[2]!['meaning'] as String,
          ]..shuffle();
        }else if (randomNumber == 1){
          question = '${randomWordData['meaning']}';
          correctAnswer = randomWordData['word'];

          // Şıkları karıştırın ve sırayla A, B, C olarak atayın
          choices = [
            randomWordsData[0]!['word'] as String,
            randomWordsData[1]!['word'] as String,
            randomWordsData[2]!['word'] as String,
          ]..shuffle();
        }

      });
    }
  }


  void _failedMessage(){
    final snackBar = SnackBar(
      content: Text("YANLIŞ CEVAP!",style: widgets.text_style(),),
      action: SnackBarAction(
        label: 'Tamam',
        onPressed: () {
          // Eylem gerçekleştiğinde burada bir şey yapabilirsiniz.
        },
      ),
    );

    ScaffoldMessenger.of(context).showSnackBar(snackBar);

  }
  void _successMessage(){
    final snackBar = SnackBar(
      content: Text("CEVAP DOĞRU", style: widgets.text_style(),),

    );

    ScaffoldMessenger.of(context).showSnackBar(snackBar);

  }

  // Diğer işlevler ve build metodu burada bulunmalıdır

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: widgets.buildAppBar("Kelimenin Karşılığı Nedir"),
      body: Column(
        crossAxisAlignment: CrossAxisAlignment.center,
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Card(
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
            elevation: 20,
            color:Color(0XFF09B7E6) ,
            child: Column(
              children: [

                Container(

                  width: MediaQuery.of(context).size.width*0.7,
                  decoration: BoxDecoration( border: Border.all(width: 0.6, style: BorderStyle.solid), borderRadius: BorderRadius.circular(20), color: Color(0xFFF0C70A)),
                  alignment: Alignment.center,
                  margin: EdgeInsets.only(top: 10),
                  padding: EdgeInsets.all(16.0),
                  child: Text(
                    question,
                    style: widgets.text_style(),
                  ),
                ),
                SizedBox(height: 20),
                Column(
                  children: choices.asMap().entries.map((entry) {
                    final index = entry.key;
                    final choice = entry.value;

                    return ListTile(

                      title: Container(
                          decoration: BoxDecoration(borderRadius: BorderRadius.circular(20), color: boxColor),
                          height: MediaQuery.of(context).size.height*0.07,
                          child: Center(child: Text('$choice', textAlign: TextAlign.center, style: widgets.text_style()))), // A, B, C şeklinde şıkları numaralandırır
                      onTap: () {

                          if (choice == correctAnswer) {
                            // Doğru cevap verildiğinde yeni soruyu oluşturun
                            _successMessage();
                            _initializeQuiz();
                          } else {
                            _failedMessage();
                          }
                      },
                    );
                  }).toList(),
                ),
                SizedBox(height: 20),

              ],
            ),

          ),

        ],
      ),
    );
  }
}
