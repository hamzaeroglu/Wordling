import 'dart:async';
import 'dart:math';

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_messaging/firebase_messaging.dart';

class DataProvider {
  final StreamController<Map<String, dynamic>> _wordStreamController =
  StreamController<Map<String, dynamic>>();

  final FirebaseMessaging _firebaseMessaging = FirebaseMessaging.instance;
  Stream<Map<String, dynamic>> get wordStream => _wordStreamController.stream;

  // Rastgele kelimenin değiştiği zamanı izlemek için bir işlev ekleyin
  void listenForWordChange(void Function() callback) {
    _wordStreamController.stream.listen((data) {
      // Yeni kelime alındığında bu işlevi çağırın
      callback();
    });
  }

  Future<Map<String, dynamic>?> getLastWord() async {
    final documentSnapshot =
    await FirebaseFirestore.instance.collection('last_word').doc('last').get();

    if (documentSnapshot.exists) {
      return documentSnapshot.data() as Map<String, dynamic>?;
    }

    return null;
  }

  void saveLastWord(Map<String, dynamic> wordData) {
    FirebaseFirestore.instance.collection('last_word').doc('last').set(wordData);
  }

  Future<Map<String, dynamic>?> getRandomWord() async {
    final alphabet = 'abcdefghijklmnopqrstuvwxyz';
    final random = Random();
    final randomLetter = alphabet[random.nextInt(alphabet.length)];

    final letterDocument = FirebaseFirestore.instance.collection('words').doc(randomLetter);
    final documentSnapshot = await letterDocument.get();

    if (documentSnapshot.exists) {
      final words = documentSnapshot.data()?['words'];
      if (words != null && words.isNotEmpty) {
        final newWordData = words[random.nextInt(words.length)];

        // Veriyi akışa aktar ve yeni kelimeyi döndür
        _wordStreamController.add(newWordData);
        return newWordData;
      }
    }

    return null;
  }

  Future<Map<String, dynamic>?> checkForNewWord() async {
    final alphabet = 'abcdefghijklmnopqrstuvwxyz';
    final random = Random();
    final randomLetter = alphabet[random.nextInt(alphabet.length)];

    final letterDocument = FirebaseFirestore.instance.collection('words').doc(randomLetter);
    final documentSnapshot = await letterDocument.get();

    if (documentSnapshot.exists) {
      final words = documentSnapshot.data()?['words'];
      if (words != null && words.isNotEmpty) {
        final newWordData = words[random.nextInt(words.length)];

        return newWordData;
      }
    }

    return null;
  }




  void dispose() {
    _wordStreamController.close();
  }
}
